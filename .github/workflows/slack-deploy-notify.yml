# main Î∏åÎûúÏπòÏóê Î®∏ÏßÄÎêòÎ©¥ VercelÏù¥ ÏûêÎèô Î∞∞Ìè¨ÌïòÍ≥†,
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä Î≥ÄÍ≤ΩÎêú ÌéòÏù¥ÏßÄ Î™©Î°ùÍ≥º Ìï®Íªò Slack ÏïåÎ¶ºÏùÑ Î≥¥ÎÉÖÎãàÎã§.
#
# ÌïÑÏöîÌïú GitHub Secrets:
#   - SLACK_WEBHOOK_URL: Slack Incoming Webhook URL

name: Slack Deploy Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed
        run: |
          if git rev-parse HEAD^2 >/dev/null 2>&1; then
            # Î®∏ÏßÄ Ïª§Î∞ã: main Ï™Ω Î∂ÄÎ™®(HEAD^1)ÏôÄ ÌòÑÏû¨(HEAD) ÎπÑÍµê
            CHANGED=$(git diff --name-only HEAD^1 HEAD)
          else
            # ÏùºÎ∞ò Ïª§Î∞ã
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Convert files to routes
        id: routes
        env:
          DEPLOYMENT_URL: https://desttiny.vercel.app
        run: |
          node scripts/files-to-routes.js "${{ steps.changed.outputs.files }}"

      - name: Prepare commit message
        id: commit
        run: |
          # Ïª§Î∞ã Î©îÏãúÏßÄ Ï≤´ Ï§ÑÎßå Ï∂îÏ∂ú (JSON Íπ®Ïßê Î∞©ÏßÄ)
          FIRST_LINE=$(git log -1 --format="%s")
          echo "title=${FIRST_LINE}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          COMMIT_TITLE: ${{ steps.commit.outputs.title }}
          ROUTES: ${{ steps.routes.outputs.routes }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          ACTOR: ${{ github.actor }}
        run: |
          PAYLOAD=$(cat <<EOF
          {
            "blocks": [
              {
                "type": "header",
                "text": { "type": "plain_text", "text": "üöÄ desttiny ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨", "emoji": true }
              },
              {
                "type": "section",
                "fields": [
                  { "type": "mrkdwn", "text": "*Ïª§Î∞ã:*\n${COMMIT_TITLE}" },
                  { "type": "mrkdwn", "text": "*ÏûëÏÑ±Ïûê:*\n${ACTOR}" }
                ]
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "*üìÑ ÏàòÏ†ïÎêú ÌéòÏù¥ÏßÄ:*\n${ROUTES}" }
              },
              {
                "type": "section",
                "text": { "type": "mrkdwn", "text": "<https://desttiny.vercel.app|üîó Î∞∞Ìè¨ ÌôïÏù∏>  |  <${COMMIT_URL}|üìù Ïª§Î∞ã ÏÉÅÏÑ∏>" }
              }
            ]
          }
          EOF
          )

          echo "Sending to Slack..."
          RESPONSE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL")

          echo "HTTP Status: $RESPONSE"
          echo "Slack response: $(cat /tmp/slack_response.txt)"

          if [ "$RESPONSE" != "200" ]; then
            echo "Slack Ï†ÑÏÜ° Ïã§Ìå®"
            exit 1
          fi

          echo "Slack Ï†ÑÏÜ° ÏÑ±Í≥µ ‚úÖ"
