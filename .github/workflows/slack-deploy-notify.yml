# main Î∏åÎûúÏπòÏóê Î®∏ÏßÄÎêòÎ©¥ VercelÏù¥ ÏûêÎèô Î∞∞Ìè¨ÌïòÍ≥†,
# Ïù¥ ÏõåÌÅ¨ÌîåÎ°úÏö∞Í∞Ä Î≥ÄÍ≤ΩÎêú ÌéòÏù¥ÏßÄ Î™©Î°ùÍ≥º Ìï®Íªò Slack ÏïåÎ¶ºÏùÑ Î≥¥ÎÉÖÎãàÎã§.
#
# ÌïÑÏöîÌïú GitHub Secrets:
#   - SLACK_WEBHOOK_URL: Slack Incoming Webhook URL

name: Slack Deploy Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµêÌïòÍ∏∞ ÏúÑÌï¥ 2Í∞ú Ïª§Î∞ã Í∞ÄÏ†∏Ïò¥

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed
        run: |
          # Î®∏ÏßÄ Ïª§Î∞ãÏùò Í≤ΩÏö∞ Î∂ÄÎ™® Ïª§Î∞ãÍ≥º ÎπÑÍµê, ÏùºÎ∞ò Ïª§Î∞ãÏùÄ Ïù¥Ï†Ñ Ïª§Î∞ãÍ≥º ÎπÑÍµê
          if git rev-parse HEAD^2 >/dev/null 2>&1; then
            CHANGED=$(git diff --name-only HEAD^1 HEAD)
          else
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Convert files to routes
        id: routes
        env:
          DEPLOYMENT_URL: https://desttiny.vercel.app
        run: |
          node scripts/files-to-routes.js "${{ steps.changed.outputs.files }}"

      - name: Prepare commit message
        id: commit
        run: |
          # Ïª§Î∞ã Î©îÏãúÏßÄ Ï≤´ Ï§ÑÎßå Ï∂îÏ∂ú (JSON Íπ®Ïßê Î∞©ÏßÄ)
          FIRST_LINE=$(git log -1 --format="%s")
          echo "title=${FIRST_LINE}" >> $GITHUB_OUTPUT

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "üöÄ desttiny ÌîÑÎ°úÎçïÏÖò Î∞∞Ìè¨",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Ïª§Î∞ã:*\n${{ steps.commit.outputs.title }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ÏûëÏÑ±Ïûê:*\n${{ github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*üìÑ ÏàòÏ†ïÎêú ÌéòÏù¥ÏßÄ:*\n${{ steps.routes.outputs.routes }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://desttiny.vercel.app|üîó Î∞∞Ìè¨ ÌôïÏù∏>  |  <${{ github.event.head_commit.url }}|üìù Ïª§Î∞ã ÏÉÅÏÑ∏>"
                  }
                }
              ]
            }
