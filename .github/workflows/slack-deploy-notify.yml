# main ë¸Œëœì¹˜ì— ë¨¸ì§€ë˜ë©´ Vercelì´ ìë™ ë°°í¬í•˜ê³ ,
# ì´ ì›Œí¬í”Œë¡œìš°ê°€ ë³€ê²½ëœ í˜ì´ì§€ ëª©ë¡ê³¼ í•¨ê»˜ Slack ì•Œë¦¼ì„ ë³´ëƒ…ë‹ˆë‹¤.
#
# í•„ìš”í•œ GitHub Secrets:
#   - SLACK_WEBHOOK_URL: Slack Incoming Webhook URL

name: Slack Deploy Notification

on:
  push:
    branches: [main]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2 # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´ 2ê°œ ì»¤ë°‹ ê°€ì ¸ì˜´

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get changed files
        id: changed
        run: |
          # ë¨¸ì§€ ì»¤ë°‹ì˜ ê²½ìš° ë¶€ëª¨ ì»¤ë°‹ê³¼ ë¹„êµ, ì¼ë°˜ ì»¤ë°‹ì€ ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
          if git rev-parse HEAD^2 >/dev/null 2>&1; then
            # ë¨¸ì§€ ì»¤ë°‹: main ìª½ ë¶€ëª¨(HEAD^1)ì™€ í˜„ì¬(HEAD) ë¹„êµ
            CHANGED=$(git diff --name-only HEAD^1 HEAD)
          else
            # ì¼ë°˜ ì»¤ë°‹
            CHANGED=$(git diff --name-only HEAD~1 HEAD)
          fi

          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Convert files to routes
        id: routes
        env:
          DEPLOYMENT_URL: https://desttiny.vercel.app
        run: |
          node scripts/files-to-routes.js "${{ steps.changed.outputs.files }}"

      - name: Send Slack notification
        uses: slackapi/slack-github-action@v2.1.0
        with:
          webhook: ${{ secrets.SLACK_WEBHOOK_URL }}
          webhook-type: incoming-webhook
          payload: |
            {
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "ğŸš€ desttiny í”„ë¡œë•ì…˜ ë°°í¬",
                    "emoji": true
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*ì»¤ë°‹:*\n${{ github.event.head_commit.message }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*ì‘ì„±ì:*\n${{ github.event.head_commit.author.username || github.actor }}"
                    }
                  ]
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸ“„ ìˆ˜ì •ëœ í˜ì´ì§€:*\n${{ steps.routes.outputs.routes }}"
                  }
                },
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "<https://desttiny.vercel.app|ğŸ”— ë°°í¬ í™•ì¸>  |  <${{ github.event.head_commit.url }}|ğŸ“ ì»¤ë°‹ ìƒì„¸>"
                  }
                }
              ]
            }
